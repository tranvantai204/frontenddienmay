<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ</title>
    <link rel="stylesheet" href="home.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .flash-sale {
            background-color: #f44336; /* Màu nền đỏ */
            padding: 20px;
            border-radius: 8px;
            color: white;
            width: 100%;
            max-height: 400px;
            max-width: 1600px;
            margin: 0 auto;
            overflow: hidden;
        }

        .flash-sale-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            animation: blink 1s step-start infinite; /* Hiệu ứng nháy */
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .products {
            display: flex;
            transition: transform 0.5s ease;
            width: calc(100% * 3); /* Điều chỉnh dựa trên số lượng slide */
        }

        .product {
            flex: 0 0 20%; /* 5 sản phẩm mỗi hàng */
            box-sizing: border-box;
            padding: 10px;
            background: white;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        button.prev, button.next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            z-index: 1;
            border-radius: 50%;
        }

        button.prev {
            left: 0;
        }

        button.next {
            right: 0;
        }

        button.prev:hover, button.next:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .product h4 {
            margin: 10px 0;
            font-size: 1em;
            height: auto; /* Đặt chiều cao tự động để cho phép xuống dòng */
            overflow: hidden; /* Ẩn phần thừa nếu có */
            text-overflow: ellipsis; /* Hiệu ứng chấm ba nếu quá dài */
            white-space: normal; /* Cho phép xuống dòng */
            line-height: 1.2; /* Đặt chiều cao dòng để dễ đọc */
        }


.featured-products {
    display: flex;
    flex-wrap: wrap; /* Cho phép các sản phẩm xuống dòng */
    justify-content: space-between; /* Căn giữa các sản phẩm */
    gap: 20px; /* Khoảng cách giữa các sản phẩm */
}

.featured-products .product {
    flex: 0 0 calc(20% - 20px); /* Điều chỉnh kích thước sản phẩm */
    box-sizing: border-box;
    padding: 15px;
    background: white;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
    min-height: 420px;
    transition: box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

        .featured-products .product img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .featured-products .product h4 {
            margin: 10px 0;
            font-size: 1em;
            min-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            line-height: 1.2;
        }

        .featured-products .product p {
            color: #e44d26;
            font-weight: bold;
            margin: 10px 0;
        }

        .featured-products .product button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            width: auto;
            margin: 0 auto;
            display: inline-block;
        }

        .featured-products .product button:hover {
            background: #45a049;
        }

        .pagination {
    display: flex;
    justify-content: center; /* Căn giữa các nút phân trang */
    align-items: center;
    margin: 20px 0; /* Khoảng cách trên và dưới */
}

.pagination button {
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    padding: 10px 15px;
    margin: 0 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.pagination button.active {
    background-color: #4CAF50; /* Màu nền cho nút đang hoạt động */
    color: white;
}

.pagination button:disabled {
    background-color: #e0e0e0; /* Màu nền cho nút không hoạt động */
    cursor: not-allowed;
}

.pagination button:hover:not(:disabled) {
    background-color: #ddd; /* Màu nền khi hover */
}

        .category-nav {
            margin: 20px 0;
            width: 100%;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-list li {
            margin: 0;
        }

        .category-list a {
            display: inline-block;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.3s;
        }

        .category-list a:hover {
            background-color: #e0e0e0;
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }


        .filter-controls {
    display: flex; /* Đảm bảo các phần tử con được hiển thị theo hàng */
    gap: 10px; /* Khoảng cách giữa các phần tử */
}

.filter-controls button {
    padding: 8px 12px; /* Kích thước nút */
    border: 1px solid #ddd; /* Đường viền */
    border-radius: 4px; /* Bo góc */
    background-color: #4CAF50; /* Màu nền */
    color: white; /* Màu chữ */
    cursor: pointer; /* Con trỏ khi hover */
}

.filter-controls button:hover {
    background-color: #45a049; /* Màu nền khi hover */
}

        .category-nav {
            flex-grow: 1;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-list li {
            margin: 0;
        }

        .category-list a {
            display: inline-block;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .category-list a:hover {
            background-color: #e0e0e0;
        }

        .category-link {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
        }

        .category-link:hover {
            background-color: #e0e0e0;
        }

        .category-link.active {
            background-color: #4CAF50;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background-color: #f8d7da;
            border-radius: 4px;
        }

        .no-products {
            text-align: center;
            padding: 20px;
            color: #856404;
            background-color: #fff3cd;
            border-radius: 4px;
        }

        .banner {
            background-color: #4a3d93; /* Màu nền banner */
            color: white; /* Màu chữ */
            text-align: center; /* Căn giữa nội dung */
            padding: 20px 0; /* Khoảng cách trên dưới */
            border-radius: 8px; /* Bo góc */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Đổ bóng */
            max-width: 1600px;
            margin: 0 auto;
        }

        .banner h1 {
            margin: 0;
            font-size: 2em;
        }

        .banner p {
            margin: 10px 0 0;
            font-size: 1.2em;
        }

        .slider {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
        }

        .slides {
            display: flex;
            transition: transform 0.5s ease-in-out;
            width: 100%; /* 100% x số lượng ảnh */
        }

        .slides img {
            width: 100%;
            flex: 0 0 100%; /* Mỗi ảnh chiếm 100% chiều rộng slider */
            border-radius: 8px;
        }

        /* button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
        } */

        .prev {
            left: 10px;
        }

        .next {
            right: 10px;
        }

        @keyframes bounceIn {
            from, 20%, 40%, 60%, 80%, to {
                animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% {
                opacity: 0;
                transform: scale3d(.3, .3, .3);
            }
            20% {
                transform: scale3d(1.1, 1.1, 1.1);
            }
            40% {
                transform: scale3d(.9, .9, .9);
            }
            60% {
                opacity: 1;
                transform: scale3d(1.03, 1.03, 1.03);
            }
            80% {
                transform: scale3d(.97, .97, .97);
            }
            to {
                opacity: 1;
                transform: scale3d(1, 1, 1);
            }
        }
        .animated {
            animation-duration: 1s;
            animation-fill-mode: both;
        }
        .bounceIn {
            animation-name: bounceIn;
        }
    </style>
</head>
<body>
    <header>
        <!-- Header code remains the same -->
        <div id="top-header">
            <ul>
                <li id="greeting" style="display: none;">Xin chào <a id="username">info</a></li>
                <li id="login-link"><a href="login.html">Đăng nhập</a></li>
                <li id="account-link" style="display: none;"><a href="infomationuser.html">Tài khoản của tôi</a></li>
                <li id="order-link" style="display: none;"><a href="listorder.html">Danh sách đơn hàng đã mua</a></li>
                <li id="logout-link" style="display: none;"><a href="login.html" onclick="logout()">Đăng xuất</a></li>
            </ul>
        </div>
        <div id="header">
            <div class="logo">
                <a href="#"><img src="./img/logo.png" alt="Logo" style="max-width: 100px; max-height: 50px;"></a>
            </div>
            <div class="search-bar">
                <form onsubmit="return false;">
                    <input type="text" id="search-input" placeholder="Tìm kiếm..." style="width: 270px; border-radius: 8px; height: 30px;">
                    <button type="submit">Tìm kiếm</button>
                </form>
            </div>
            <div class="cart">
                <a href="cart.html" style="margin-right: 14px;"><i class="fa fa-shopping-cart"></i> Giỏ hàng</a>
            </div>
        </div>
    </header>
    
    <section class="banner">
        <h1>Chào mừng đến với Điện máy X!</h1>
        <p>Khám phá các ưu đãi mới nhất của chúng tôi.</p>
        
        <div class="slider">
            <div class="slides">
                <img src="img/banner1.jpg" alt="Banner 1">
                <img src="img/banner2.jpg" alt="Banner 2">
                <img src="img/banner3.jpg" alt="Banner 3">
                <img src="img/banner4.jpg" alt="Banner 4">
                <img src="img/banner5.jpg" alt="Banner 5">
            </div>
            <button class="prev" onclick="changeSlide(-1)">&#10094;</button>
            <button class="next" onclick="changeSlide(1)">&#10095;</button>
        </div>
    </section>
    <section>
        <!-- <div class="filter-section">
            <div class="filter-controls">
                <select id="sort-by">
                    <option value="price">Giá</option>
                    <option value="product_name">Tên</option>
                    <option value="created_at">Ngày tạo</option>
                </select>
                <select id="sort-order">
                    <option value="ASC">Tăng dần</option>
                    <option value="DESC">Giảm dần</option>
                </select>
                <button onclick="applyFilters()">Lọc</button>
            </div>
            
            <nav class="category-nav">
                <ul id="category-menu" class="category-list">                </ul>
            </nav>
        </div> -->
        <div class="filter-section"></div>
            <h3>Bộ lọc</h3><br>
            <!-- <select id="brand-filter">
                <option value="">None</option> 
                <option value="Apple">Apple</option>
                <option value="Samsung">Samsung</option>
                <option value="MacBook">MacBook</option>
                <option value="ASUS">ASUS</option>
                <option value="Sony">Sony</option>
                <option value="Lenovo">Lenovo</option>
            </select> -->
            <select id="sort-by" onchange="updateSortOptions()">
                <option value="price">Giá</option>
                <option value="product_name">Tên</option>
                <option value="created_at">Ngày tạo</option>
            </select>
            <select id="sort-order">
                <option value="ASC">Tăng dần</option>
                <option value="DESC">Giảm dần</option>
            </select>
            <select id="items-per-page">
                <option value="10">10 sản phẩm</option>
                <option value="20">20 sản phẩm</option>
                <option value="30">30 sản phẩm</option>
            </select>
            <button onclick="applyFilters()" style="top:auto; width: 60px; background: #5cb85c; color: white; ">Lọc</button>
        </div>
        <section class="category-nav">
            <h3>Danh mục sản phẩm</h3>
            <ul id="category-menu" class="category-list">
                <!-- Danh mục sẽ được thêm vào đây -->
            </ul>
        </section>
    
        <section class="featured">
            <h3 class="section-title">Sản phẩm nổi bật</h3>
            <div id="featured-products" class="featured-products">
                <!-- Sản phẩm sẽ được thêm vào đây -->
            </div>
            <div class="pagination" id="pagination">
                <button onclick="changeFeaturedPage(currentFeaturedPage - 1)" ${currentFeaturedPage === 1 ? 'disabled' : ''}>Quay lại</button>
                <!-- Các nút số trang sẽ được thêm vào đây -->
                <button onclick="changeFeaturedPage(currentFeaturedPage + 1)" ${currentFeaturedPage === totalPages ? 'disabled' : ''}>Tiếp</button>
            </div>
        </section>

    </section>
    
    
    <footer>
        <br><br><p>&copy; 2024 Trang Bán Hàng.</p>
    </footer>

    <script>
        // Global variables for state management
        let categories = [];
        let currentFeaturedPage = 1;
        let totalPages = 1;
        let currentCategory = null;
        let currentSort = {
            by: 'product_id',
            order: 'DESC'
        };
        let itemsPerPage = 20;

        // Base API URL - Replace with your actual API URL
        const BASE_API_URL = 'http://localhost/CuaHangDT';

        // Function to fetch products from the API
        async function fetchProducts(page = 1, limit = itemsPerPage, sort_by = currentSort.by, sort_order = currentSort.order, category_id = currentCategory) {
            try {
                let url = `${BASE_API_URL}/api/sanPham/read.php?page=${page}&limit=${limit}&sort_by=${sort_by}&sort_order=${sort_order}`;
                if (category_id) {
                    url += `&category_id=${category_id}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching products:', error);
                throw error;
            }
        }

        async function fetchCategories() {
        try {
            const response = await fetch(`${BASE_API_URL}/api/danhMucSP/read.php`);
            const data = await response.json();
            return data.data || [];
        } catch (error) {
            console.error('Error fetching categories:', error);
            throw error;
        }
    }

        // Function to display products in the featured products section
        function displayProducts(products) {
            const featuredProductsContainer = document.getElementById('featured-products');
            featuredProductsContainer.innerHTML = '';

            if (!products || products.length === 0) {
                featuredProductsContainer.innerHTML = '<div class="no-products">Không tìm thấy sản phẩm nào</div>';
                return;
            }

            products.forEach(product => {
                // Log để debug
                console.log('Product data:', product);

                const productElement = document.createElement('div');
                productElement.className = 'product';
                productElement.innerHTML = `
                    <div class="product-image" style="cursor: pointer;">
                        <img src="${product.thumbnail_image}" alt="${product.product_name}">
                    </div>
                    <h4 class="product-name" style="cursor: pointer; min-height: 20px;">
                        ${product.product_name || 'Không có tên'}
                    </h4>
                    <p>${formatPrice(product.price)} VNĐ</p>
                    <button class="add-to-cart" data-product-id="${product.product_id}">Thêm vào giỏ hàng</button>
                `;

                // Thêm sự kiện click cho ảnh và tên sản phẩm
                const productImage = productElement.querySelector('.product-image');
                const productName = productElement.querySelector('.product-name');
                
                const viewProductDetail = () => {
                    window.location.href = `informationproduct.html?id=${product.product_id}`;
                };

                productImage.addEventListener('click', viewProductDetail);
                productName.addEventListener('click', viewProductDetail);

                // Gán sự kiện click cho nút thêm vào giỏ hàng
                const addToCartBtn = productElement.querySelector('.add-to-cart');
                addToCartBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const productId = this.getAttribute('data-product-id');
                    console.log('Clicked product ID:', productId);
                    addToCart(productId); // Gọi hàm thêm vào giỏ hàng
                });

                featuredProductsContainer.appendChild(productElement);
            });
        }

        // Function to display categories in the navigation
        function displayCategories(categories) {
            const categoryMenu = document.getElementById('category-menu');
            if (!categoryMenu) return;

            // Add "All Products" option
            categoryMenu.innerHTML = `
                <li>
                    <a href="#" 
                    class="category-link ${!currentCategory ? 'active' : ''}" 
                    onclick="filterByCategory(null); return false;">
                    Tất cả sản phẩm
                    </a>
                </li>
            `;

            // Add each category
            categories.forEach(category => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" 
                    class="category-link ${currentCategory === category.category_id ? 'active' : ''}"
                    data-category-id="${category.category_id}"
                    onclick="filterByCategory(${category.category_id}); return false;">
                    ${category.category_name}
                    </a>
                `;
                categoryMenu.appendChild(li);
            });
        }

        // Function to fetch category details
        async function fetchCategoryDetails(categoryId) {
            try {
                const response = await fetch(`${BASE_API_URL}/api/danhMucSP/show.php?id=${categoryId}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching category details:', error);
                throw error;
            }
        }

        // Function to update pagination
        function updatePagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';

            // Previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = 'Quay lại';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePage(currentPage - 1);
            paginationContainer.appendChild(prevButton);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerHTML = i;
                pageButton.className = currentPage === i ? 'active' : '';
                pageButton.onclick = () => changePage(i);
                paginationContainer.appendChild(pageButton);
            }

            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = 'Tiếp';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePage(currentPage + 1);
            paginationContainer.appendChild(nextButton);
        }

        // Function to change page
        async function changePage(page) {
            try {
                currentFeaturedPage = page;
                // Lấy giá trị hiện tại của các bộ lọc
                const sortBy = document.getElementById('sort-by').value;
                const sortOrder = document.getElementById('sort-order').value;
                
                // Gọi fetchProducts với đầy đủ tham số
                const data = await fetchProducts(
                    page,
                    itemsPerPage,
                    sortBy,
                    sortOrder,
                    currentCategory
                );

                if (data && data.data) {
                    displayProducts(data.data);
                    if (data.paging) {
                        updatePagination(data.paging.current_page, data.paging.total_pages);
                    }
                } else {
                    console.error('Invalid data format received');
                }
            } catch (error) {
                console.error('Error changing page:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể chuyển trang. Vui lòng thử lại sau.',
                    showConfirmButton: true
                });
            }
        }

        // Function to apply filters
        async function applyFilters() {
            try {
                const sortBy = document.getElementById('sort-by').value;
                const sortOrder = document.getElementById('sort-order').value;
                
                console.log('Applying filters:', { sortBy, sortOrder }); // Debug log

                // Tạo URL với các tham số lọc
                let url = `http://localhost/CuaHangDT/api/sanPham/read.php?sort_by=${sortBy}&sort_order=${sortOrder}`;
                
                // Thêm category_id nếu có
                if (currentCategory) {
                    url += `&category_id=${currentCategory}`;
                }

                console.log('Filter URL:', url); // Debug log

                const response = await fetch(url);
                const data = await response.json();
                console.log('Filtered data:', data); // Debug log

                // Kiểm tra xem data có thuộc tính data không
                if (data && data.data && Array.isArray(data.data)) {
                    displayProducts(data.data);
                    if (data.paging) {
                        updatePagination(data.paging.current_page, data.paging.total_pages);
                    }
                } else {
                    console.error('Invalid data format:', data);
                    throw new Error('Dữ liệu không hợp lệ từ server');
                }

            } catch (error) {
                console.error('Error in applyFilters:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể lọc sản phẩm. Vui lòng thử lại sau.',
                    showConfirmButton: true
                });
            }
        }

        // Thêm event listeners cho các controls lọc
        document.addEventListener('DOMContentLoaded', () => {
            const sortBySelect = document.getElementById('sort-by');
            const sortOrderSelect = document.getElementById('sort-order');
            
            if (sortBySelect && sortOrderSelect) {
                // Gán sự kiện change cho các select
                sortBySelect.addEventListener('change', applyFilters);
                sortOrderSelect.addEventListener('change', applyFilters);
            }
        });

        // Function to filter by category
        async function filterByCategory(categoryId) {
            currentCategory = categoryId;
            
            try {
                // Update active category visual
                document.querySelectorAll('.category-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                if (categoryId) {
                    const categoryLink = document.querySelector(`[data-category-id="${categoryId}"]`);
                    if (categoryLink) {
                        categoryLink.classList.add('active');
                    }

                    // Fetch and display category details if needed
                    const categoryDetails = await fetchCategoryDetails(categoryId);
                    // You can use categoryDetails to show additional information
                    // For example, updating a category description section
                    if (categoryDetails.description) {
                        const categoryDescElement = document.getElementById('category-description');
                        if (categoryDescElement) {
                            categoryDescElement.textContent = categoryDetails.description;
                        }
                    }
                } else {
                    // "All Products" is selected
                    document.querySelector('.category-link').classList.add('active');
                }

                // Fetch and display products for the selected category
                const data = await fetchProducts(1, itemsPerPage, currentSort.by, currentSort.order, categoryId);
                displayProducts(data.data);
                updatePagination(1, data.paging.total_pages);
                
            } catch (error) {
                console.error('Error in filterByCategory:', error);
                // Show error message to user
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể tải danh mục sản phẩm. Vui lòng thử lại sau.',
                });
            }
        }

        // Function to format price with thousands separator
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN').format(price);
        }

        // Function to search products
        async function searchProducts() {
            try {
                const searchTerm = document.getElementById('search-input').value.trim();
                console.log('Searching for:', searchTerm); // Debug log

                if (!searchTerm) {
                    // Nếu không có từ khóa, load lại tất cả sản phẩm
                    const data = await fetchProducts();
                    if (data && data.data) {
                        displayProducts(data.data);
                    }
                    return;
                }

                // Lấy tất cả sản phẩm và lọc ở client side
                const response = await fetch(`${BASE_API_URL}/api/sanPham/read.php`);
                const data = await response.json();
                console.log('All products:', data); // Debug log

                if (data && data.data && Array.isArray(data.data)) {
                    // Lọc sản phẩm theo tên, không phân biệt hoa thường và dấu
                    const filteredProducts = data.data.filter(product => 
                        product.product_name.toLowerCase()
                            .normalize('NFD')
                            .replace(/[\u0300-\u036f]/g, '')
                            .includes(
                                searchTerm.toLowerCase()
                                    .normalize('NFD')
                                    .replace(/[\u0300-\u036f]/g, '')
                            )
                    );

                    console.log('Filtered products:', filteredProducts); // Debug log

                    if (filteredProducts.length > 0) {
                        displayProducts(filteredProducts);
                    } else {
                        document.getElementById('featured-products').innerHTML = 
                            '<div class="no-products">Không tìm thấy sản phẩm phù hợp</div>';
                    }
                }

            } catch (error) {
                console.error('Error searching products:', error);
                document.getElementById('featured-products').innerHTML = 
                    '<div class="no-products">Đã xảy ra lỗi khi tìm kiếm</div>';
            }
        }

        // Thêm debounce để tránh gọi API quá nhiều lần
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Sửa lại cách gán sự kiện
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const searchForm = document.querySelector('.search-bar form');

            if (searchInput) {
                // Xử lý khi gõ
                const debouncedSearch = debounce(() => searchProducts(), 300);
                searchInput.addEventListener('input', debouncedSearch);
            }

            if (searchForm) {
                // Xử lý khi submit form
                searchForm.addEventListener('submit', handleSearchSubmit);
            }
        });

        // Thêm hàm xử lý submit form
        async function handleSearchSubmit(event) {
            event.preventDefault(); // Ngăn form reload trang
            await searchProducts();
        }

        // Initialize page
        async function initializePage() {
            try {
                // Fetch categories first
                const categoriesData = await fetchCategories();
                categories = categoriesData;
                displayCategories(categories);

                // Then fetch and display products
                const data = await fetchProducts();
                displayProducts(data.data);
                updatePagination(data.paging.current_page, data.paging.total_pages);

                // Initialize event listeners
                document.getElementById('search-input')?.addEventListener('input', searchProducts);
                
                // Initialize filter controls
                initializeFilterControls();
            } catch (error) {
                console.error('Error initializing page:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể tải trang. Vui lòng thử lại sau.',
                });
            }
        }

        // Function to initialize filter controls
        function initializeFilterControls() {
            // Sort by select
            const sortBySelect = document.getElementById('sort-by');
            if (sortBySelect) {
                sortBySelect.value = currentSort.by;
            }

            // Sort order select
            const sortOrderSelect = document.getElementById('sort-order');
            if (sortOrderSelect) {
                sortOrderSelect.value = currentSort.order;
            }

            // Items per page select
            const itemsPerPageSelect = document.getElementById('items-per-page');
            if (itemsPerPageSelect) {
                itemsPerPageSelect.value = itemsPerPage.toString();
            }
        }

        function getUsernameFromToken(token) {
            if (!token) return null;
            const payloadBase64 = token.split('.')[1];
            if (!payloadBase64) return null;
            const payload = JSON.parse(atob(payloadBase64));
            return payload.data?.username || null;
        }

        function logout() {
            localStorage.removeItem('token');
            sessionStorage.removeItem('welcomeSeen');
            window.location.href = 'login.html';
        }

        function setupAuth() {
            const token = localStorage.getItem('token');
            const username = getUsernameFromToken(token);
            
            if (username) {
                document.getElementById('username').innerText = username;
                document.getElementById('greeting').style.display = 'inline';
                document.getElementById('account-link').style.display = 'inline';
                document.getElementById('login-link').style.display = 'none';
                document.getElementById('logout-link').style.display = 'inline';
                document.getElementById('order-link').style.display = 'inline';
            } else {
                document.getElementById('greeting').style.display = 'none';
                document.getElementById('account-link').style.display = 'none';
                document.getElementById('login-link').style.display = 'inline';
                document.getElementById('logout-link').style.display = 'none';
                document.getElementById('order-link').style.display = 'none';
            }
        }

        // Call initialize function when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePage);
        document.addEventListener('DOMContentLoaded', function() {
            setupAuth();
        });

        let currentSlide = 0;

        function changeSlide(direction) {
            const slides = document.querySelector('.slides');
            const totalSlides = slides.children.length;
            currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
            slides.style.transform = `translateX(-${currentSlide * 100}%)`;
        }

        // Tự động lướt
        setInterval(() => {
            changeSlide(1);
        }, 3000); // Thay đổi slide mỗi 3 giây

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            
            const cartButtons = document.querySelectorAll('.add-to-cart');
            console.log('Found cart buttons:', cartButtons.length);
            
            cartButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    console.log('Cart button clicked');
                    const productId = event.target.getAttribute('data-product-id');
                    console.log('Product ID:', productId);
                    if (productId) {
                        addToCart(productId);
                    } else {
                        console.error('No product ID found on button');
                    }
                });
            });
        });

        async function addToCart(productId) {
            // Kiểm tra token
            const token = localStorage.getItem('token');
            if (!token) {
                Swal.fire({
                    icon: 'error',
                    title: 'Vui lòng đăng nhập',
                    text: 'Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng',
                    showCancelButton: true,
                    confirmButtonText: 'Đăng nhập',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Chuyển hướng đến trang đăng nhập
                        window.location.href = 'login.html';
                    }
                });
                return;
            }

            // Kiểm tra product ID
            if (!productId) {
                console.error('Product ID is missing');
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không tìm thấy thông tin sản phẩm',
                    showConfirmButton: true
                });
                return;
            }

            try {
                console.log('Attempting to add product to cart:', productId); // Debug log

                const response = await fetch('http://localhost/CuaHangDT/api/giohang/add_to_cart.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: 1
                    })
                });

                console.log('Response status:', response.status); // Debug log

                // Kiểm tra response
                const responseText = await response.text();
                console.log('Response text:', responseText); // Debug log

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    throw new Error('Invalid JSON response from server');
                }

                if (!response.ok) {
                    throw new Error(data.message || 'Server returned error status');
                }

                if (data.message && data.message.includes('successfully')) {
                    // Cập nhật số lượng giỏ hàng
                    updateCartCount();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Sản phẩm đã được thêm vào giỏ hàng',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(data.message || 'Unknown error occurred');
                }

            } catch (error) {
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });

                // Hiển thị thông báo lỗi chi tiết
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    html: `
                        <p>Không thể thêm sản phẩm vào giỏ hàng</p>
                        <p style="font-size: 0.8em; color: #666;">Chi tiết lỗi: ${error.message}</p>
                        ${error.stack ? `<pre style="font-size: 0.7em; color: #999; text-align: left;">${error.stack}</pre>` : ''}
                    `,
                    showConfirmButton: true
                });
            }
        }

        // Hàm cập nhật số lượng giỏ hàng
        async function updateCartCount() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch('http://localhost/CuaHangDT/api/giohang/get_cart.php', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch cart count');
                }

                const data = await response.json();
                console.log('Cart data:', data); // Debug log

                // Cập nhật số lượng trong giỏ hàng trên UI
                const cartCount = document.getElementById('cart-count');
                if (cartCount) {
                    cartCount.textContent = Array.isArray(data) ? data.length : '0';
                }

            } catch (error) {
                console.error('Error updating cart count:', error);
            }
        }

        function showWelcomeMessage() {
            const token = localStorage.getItem('token');
            console.log('Token:', token); // Log token

            // Kiểm tra token và trạng thái đã xem
            if (!token || sessionStorage.getItem('welcomeSeen')) {
                return;
            }

            try {
                const payloadBase64 = token.split('.')[1];
                const payload = JSON.parse(atob(payloadBase64));
                const username = payload.data?.username;

                Swal.fire({
                    title: 'Chào mừng đến với Điện máy Xanh!',
                    html: `<div style="font-size: 1.2em;">Xin chào <b style="color: #4CAF50">${username}</b>!<br>Chúc bạn có trải nghiệm mua sắm tuyệt vời.</div>`,
                    icon: 'success',
                    showConfirmButton: false, // Ẩn nút xác nhận
                    timer: 3000, // Tự động đóng sau 3 giây
                    timerProgressBar: true, // Hiển thị thanh tiến trình
                    willClose: () => {
                        sessionStorage.setItem('welcomeSeen', 'true'); // Lưu trạng thái đã xem
                    }
                });
            } catch (error) {
                console.error('Error showing welcome message:', error);
            }
        }

        // Gọi hàm khi trang được load
        document.addEventListener('DOMContentLoaded', showWelcomeMessage, { once: true });

        // Tạo một thẻ style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes bounceIn {
                from, 20%, 40%, 60%, 80%, to {
                    animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
                }
                0% {
                    opacity: 0;
                    transform: scale3d(.3, .3, .3);
                }
                20% {
                    transform: scale3d(1.1, 1.1, 1.1);
                }
                40% {
                    transform: scale3d(.9, .9, .9);
                }
                60% {
                    opacity: 1;
                    transform: scale3d(1.03, 1.03, 1.03);
                }
                80% {
                    transform: scale3d(.97, .97, .97);
                }
                to {
                    opacity: 1;
                    transform: scale3d(1, 1, 1);
                }
            }
            .animated {
                animation-duration: 1s;
                animation-fill-mode: both;
            }
            .bounceIn {
                animation-name: bounceIn;
            }
        `;

        // Thêm thẻ style vào head
        document.head.appendChild(style);
        function updateSortOptions() {
            const sortBy = document.getElementById("sort-by").value;
            const sortOrder = document.getElementById("sort-order");

            // Xóa các tùy chọn cũ
            sortOrder.innerHTML = "";

            // Cập nhật tùy chọn dựa trên tiêu chí được chọn
            if (sortBy === "price") {
                sortOrder.innerHTML = `
                    <option value="ASC">Tăng dần</option>
                    <option value="DESC">Giảm dần</option>
                `;
            } else if (sortBy === "product_name") {
                sortOrder.innerHTML = `
                    <option value="ASC">A-Z</option>
                    <option value="DESC">Z-A</option>
                `;
            } else if (sortBy === "created_at") {
                sortOrder.innerHTML = `
                    <option value="DESC">Ngày mới nhất</option>
                    <option value="ASC">Ngày cũ nhất</option>
                `;
            } 
            // else if (sortBy === "supplied_name"){
            //     sortOrder.innerHTML = `
            //         <option value="ASC">A-Z</option>
            //         <option value="DESC">Z-A</option>
            //     `
            // }
        }
 
    </script>
</body>
</html>