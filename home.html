<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ</title>
    <link rel="stylesheet" href="home.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .flash-sale {
            background-color: #f44336; /* Màu nền đỏ */
            padding: 20px;
            border-radius: 8px;
            color: white;
            width: 100%;
            max-height: 400px;
            max-width: 1600px;
            margin: 0 auto;
            overflow: hidden;
        }

        .flash-sale-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            animation: blink 1s step-start infinite; /* Hiệu ứng nháy */
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .products {
            display: flex;
            transition: transform 0.5s ease;
            width: calc(100% * 3); /* Điều chỉnh dựa trên số lượng slide */
        }

        .product {
            flex: 0 0 20%; /* 5 sản phẩm mỗi hàng */
            box-sizing: border-box;
            padding: 10px;
            background: white;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        button.prev, button.next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            z-index: 1;
            border-radius: 50%;
        }

        button.prev {
            left: 0;
        }

        button.next {
            right: 0;
        }

        button.prev:hover, button.next:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .product h4 {
            margin: 10px 0;
            font-size: 1em;
            height: auto; /* Đặt chiều cao tự động để cho phép xuống dòng */
            overflow: hidden; /* Ẩn phần thừa nếu có */
            text-overflow: ellipsis; /* Hiệu ứng chấm ba nếu quá dài */
            white-space: normal; /* Cho phép xuống dòng */
            line-height: 1.2; /* Đặt chiều cao dòng để dễ đọc */
        }

        .featured-products {
            display: flex;
            flex-wrap: wrap; /* Cho phép các sản phẩm xuống dòng */
            justify-content: space-between; /* Căn giữa các sản phẩm */
            gap: 20px; /* Khoảng cách giữa các sản phẩm */
            padding: 20px 0; /* Khoảng cách trên và dưới */
        }

        .featured-products .product {
            flex: 0 0 calc(20% - 20px); /* 5 sản phẩm mỗi hàng, trừ khoảng cách */
            box-sizing: border-box;
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            transition: box-shadow 0.3s ease;
            height: 300px; /* Đặt chiều cao cố định cho sản phẩm */
        }

        .featured-products .product img {
            width: 100%;
            height: 150px; /* Chiều cao cố định cho hình ảnh */
            object-fit: cover; /* Đảm bảo hình ảnh không bị méo */
            margin-bottom: 10px;
        }

        .featured-products .product h4 {
            margin: 10px 0;
            font-size: 1em;
            height: auto; /* Đt chiều cao tự động ể cho phép xuống dòng */
            overflow: hidden; /* Ẩn phần thừa nếu có */
            text-overflow: ellipsis; /* Hiệu ứng chấm ba nếu quá dài */
            white-space: normal; /* Cho phép xuống dòng */
            line-height: 1.2; /* Đặt chiều cao dòng để dễ đọc */
        }

        .featured-products .product p {
            color: #e44d26;
            font-weight: bold;
            margin: 10px 0;
        }

        .featured-products .product button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }

        .featured-products .product button:hover {
            background: #45a049;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .pagination button {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 10px 15px;
            margin: 0 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .pagination button.active {
            background-color: #4CAF50; /* Màu nền cho nút đang hoạt động */
            color: white;
        }

        .pagination button:disabled {
            background-color: #e0e0e0; /* Màu nền cho nút không hoạt động */
            cursor: not-allowed;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #ddd; /* Màu nền khi hover */
        }

        .category-nav {
            margin: 20px 0;
            width: 100%;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-list li {
            margin: 0;
        }

        .category-list a {
            display: inline-block;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.3s;
        }

        .category-list a:hover {
            background-color: #e0e0e0;
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 20px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-controls select, 
        .filter-controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 36px;
        }

        .filter-controls button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .filter-controls button:hover {
            background-color: #45a049;
        }

        .category-nav {
            flex-grow: 1;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-list li {
            margin: 0;
        }

        .category-list a {
            display: inline-block;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .category-list a:hover {
            background-color: #e0e0e0;
        }

        .category-link {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
        }

        .category-link:hover {
            background-color: #e0e0e0;
        }

        .category-link.active {
            background-color: #4CAF50;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background-color: #f8d7da;
            border-radius: 4px;
        }

        .no-products {
            text-align: center;
            padding: 20px;
            color: #856404;
            background-color: #fff3cd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <header>
        <!-- Header code remains the same -->
        <div id="top-header">
            <ul>
                <li id="greeting" style="display: none;">Xin chào <a id="username">info</a></li>
                <li id="login-link"><a href="login.html">Đăng nhập</a></li>
                <li id="account-link" style="display: none;"><a href="infomationuser.html">Tài khoản của tôi</a></li>
                <li id="order-link" style="display: none;"><a href="listorder.html">Danh sách đơn hàng đã mua</a></li>
                <li id="logout-link" style="display: none;"><a href="login.html" onclick="logout()">Đăng xuất</a></li>
            </ul>
        </div>
        <div id="header">
            <div class="logo">
                <a href="#"><img src="./img/logo.png" alt="Logo" style="max-width: 100px; max-height: 50px;"></a>
            </div>
            <div class="search-bar">
                <form onsubmit="return false;">
                    <input type="text" id="search-input" placeholder="Tìm kiếm..." oninput="searchProducts()">
                    <button type="submit">Tìm kiếm</button>
                </form>
            </div>
            <div class="cart">
                <a href="cart.html" style="margin-right: 14px;"><i class="fa fa-shopping-cart"></i> Giỏ hàng</a>
            </div>
        </div>
    </header>

    <section class="flash-sale">
        <h3 class="flash-sale-title">Flash Sale</h3>
        <div class="carousel">
            <button class="prev" onclick="prevFlashSaleSlide()">&#10094;</button>
            <div id="flashsale-products" class="products">
                <!-- Flash sale products will be inserted here -->
            </div>
            <button class="next" onclick="nextFlashSaleSlide()">&#10095;</button>
        </div>
    </section>
    <section>
        <div class="filter-section">
            <div class="filter-controls">
                <select id="sort-by">
                    <option value="price">Giá</option>
                    <option value="product_name">Tên</option>
                    <option value="created_at">Ngày tạo</option>
                </select>
                <select id="sort-order">
                    <option value="ASC">Tăng dần</option>
                    <option value="DESC">Giảm dần</option>
                </select>
                <select id="items-per-page">
                    <option value="10">10 sản phẩm</option>
                    <option value="20">20 sản phẩm</option>
                    <option value="30">30 sản phẩm</option>
                </select>
                <button onclick="applyFilters()">Lọc</button>
            </div>
            
            <nav class="category-nav">
                <ul id="category-menu" class="category-list">
                    <!-- Categories will be loaded here -->
                </ul>
            </nav>
        </div>


        <section class="featured">
            <h3 class="section-title">Sản phẩm nổi bật</h3>
            <div id="featured-products" class="featured-products">
                <!-- Featured products will be inserted here -->
            </div>
            <div class="pagination" id="pagination">
                <button onclick="changeFeaturedPage(currentFeaturedPage - 1)" ${currentFeaturedPage === 1 ? 'disabled' : ''}>Quay lại</button>
                <!-- Các nút số trang sẽ được thêm vào đây -->
                <button onclick="changeFeaturedPage(currentFeaturedPage + 1)" ${currentFeaturedPage === totalPages ? 'disabled' : ''}>Tiếp</button>
            </div>
        </section>

        <div class="products" id="product-list"></div>
        <div class="pagination" id="pagination"></div>
    </section>


    <footer>
        <p>&copy; 2024 Trang Bán Hàng.</p>
    </footer>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentCategory = 'all';
        let currentIndex = 0; // Chỉ số sản phẩm hiện tại

        let currentFeaturedPage = 1; // Trang hiện tại cho sản phẩm nổi bật
        let currentAllProductsPage = 1; // Trang hiện tại cho tất cả sản phẩm
        const itemsPerPage = 20; // Số sản phẩm mỗi trang
        let allProducts = []; // Biến để lưu trữ tất cả sản phẩm

        // Các biến cho Flash Sale
        let currentFlashIndex = 0;
        const flashSaleLimit = 20;

        document.addEventListener('DOMContentLoaded', function() {
            fetchCategories(); 
            fetchProducts();
            setupAuth();
            updateCartCount();
            autoSlide('flashsale-products');
        });

        function setupAuth() {
            const token = localStorage.getItem('token');
            const username = getUsernameFromToken(token);
            
            if (username) {
                document.getElementById('username').innerText = username;
                document.getElementById('greeting').style.display = 'inline';
                document.getElementById('account-link').style.display = 'inline';
                document.getElementById('login-link').style.display = 'none';
                document.getElementById('logout-link').style.display = 'inline';
                document.getElementById('order-link').style.display = 'inline';
            } else {
                document.getElementById('greeting').style.display = 'none';
                document.getElementById('account-link').style.display = 'none';
                document.getElementById('login-link').style.display = 'inline';
                document.getElementById('logout-link').style.display = 'none';
                document.getElementById('order-link').style.display = 'none';
            }
        }

        function getUsernameFromToken(token) {
            if (!token) return null;
            const payloadBase64 = token.split('.')[1];
            if (!payloadBase64) return null;
            const payload = JSON.parse(atob(payloadBase64));
            return payload.data?.username || null;
        }

        function logout() {
            localStorage.removeItem('token');
            sessionStorage.removeItem('hasSeenWelcome');
            window.location.href = 'login.html';
        }

        function fetchProducts(page = 1) {
            const url = `http://localhost/CuaHangDT/api/sanpham/read.php`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    allProducts = data.data; // Lưu trữ tất cả sản phẩm
                    displayFlashSale(allProducts); // Hiển thị sản phẩm flash sale
                    displayFeatured(allProducts); // Hiển th sản phẩm nổi bật
                    
                    // Phân trang cho phần tất cả sản phẩm
                    const start = (currentPage - 1) * itemsPerPage;
                    const end = start + itemsPerPage;
                    const paginatedProducts = allProducts.slice(start, end);
                    renderProducts(paginatedProducts, 'product-list');
                    
                    // Tính toán tổng số trang
                    const totalPages = Math.ceil(allProducts.length / itemsPerPage);
                    renderPagination(totalPages);
                })
                .catch(error => console.error('Error:', error));
        }

        async function fetchCategories() {
            try {
                console.log('Fetching categories...');
                const response = await fetch('http://localhost/CuaHangDT/api/danhMucSP/read.php');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Categories data:', data);
                
                const categoryMenu = document.getElementById('category-menu');
                if (!categoryMenu) {
                    console.error('Category menu element not found!');
                    return;
                }
                
                // Thêm class cho các elements
                const categoriesHTML = data.data.map(category => `
                    <li class="category-item">
                        <a href="#" 
                           class="category-link"
                           onclick="fetchProductsByCategory(${category.category_id}); return false;">
                            ${category.category_name}
                        </a>
                    </li>
                `).join('');
                
                // Thêm "Tất cả" với class tương tự
                const allProductsLink = `
                    <li class="category-item">
                        <a href="#" 
                           class="category-link"
                           onclick="fetchProducts(); return false;">
                            Tất cả
                        </a>
                    </li>`;
                
                categoryMenu.innerHTML = allProductsLink + categoriesHTML;
                console.log('Categories rendered successfully');
                
            } catch (error) {
                console.error('Error in fetchCategories:', error);
            }
        }

        function fetchProductsByCategory(categoryId) {
            currentCategory = categoryId;
            currentPage = 1;
            
            const limit = document.getElementById('items-per-page').value;
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value;

            // Cập nhật active state cho categories
            updateCategoryActiveState(categoryId);

            // Hiển thị loading
            const productList = document.getElementById('featured-products');
            productList.innerHTML = '<div class="loading">Đang tải sản phẩm...</div>';

            // Luôn sử dụng API read.php của sản phẩm
            let url = `http://localhost/CuaHangDT/api/sanpham/read.php`;
            
            // Thêm các tham số query
            const params = new URLSearchParams({
                page: currentPage,
                limit: limit,
                sort_by: sortBy,
                sort_order: sortOrder
            });

            // Thêm category_id nếu không phải "Tất cả"
            if (categoryId !== 'all') {
                params.append('category_id', categoryId);
            }

            url += '?' + params.toString();
            console.log('Fetching URL:', url); // Debug log

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data); // Debug log
                    
                    if (!data.data || data.data.length === 0) {
                        productList.innerHTML = '<div class="no-products">Không có sản phẩm trong danh mục này</div>';
                        return;
                    }

                    renderProducts(data.data);
                    if (data.total_pages) {
                        renderPagination(data.total_pages);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    productList.innerHTML = '<div class="error">Có lỗi xảy ra khi tải sản phẩm</div>';
                });
        }

        function applyFilters() {
            if (currentCategory) {
                fetchProductsByCategory(currentCategory);
            } else {
                fetchProducts(currentPage);
            }
        }

        function renderProducts(products) {
            const productList = document.getElementById('featured-products');
            
            if (!products || products.length === 0) {
                productList.innerHTML = 'Không có sản phẩm nào.';
                return;
            }

            const productsHTML = products.map(product => `
                <div class="product">
                    <a href="informationproduct.html?id=${product.product_id}" class="product-link">
                        <img src="${product.thumbnail_image}" alt="${product.product_name}">
                        <h4>${product.product_name}</h4>
                        <p class="product-price">Giá: ${Number(product.price).toLocaleString()} VND</p>
                    </a>
                    <button onclick="addToCart(event, ${product.product_id}, 1)">Thêm vào giỏ hàng</button>
                </div>
            `).join('');

            productList.innerHTML = productsHTML;
        }

        function renderPagination(total) {
            totalPages = total;
            const pagination = document.getElementById('pagination');
            let buttons = '';
            
            // Nút First và Previous
            buttons += `
                <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>«</button>
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>
            `;
            
            // Trang đầu tiên
            buttons += `<button onclick="changePage(1)" ${currentPage === 1 ? 'class="active"' : ''}>1</button>`;
            
            // Xử lý dấu ... và các trang ở giữa
            if (currentPage > 3) {
                buttons += `<span class="dots">...</span>`;
            }
            
            for (let i = Math.max(2, currentPage - 1); i <= Math.min(total - 1, currentPage + 1); i++) {
                if (i === currentPage) {
                    buttons += `<button class="active">${i}</button>`;
                } else {
                    buttons += `<button onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            if (currentPage < total - 2) {
                buttons += `<span class="dots">...</span>`;
            }
            
            // Trang cuối
            if (total > 1) {
                buttons += `<button onclick="changePage(${total})" ${currentPage === total ? 'class="active"' : ''}>${total}</button>`;
            }
            
            // Nút Next và Last
            buttons += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === total ? 'disabled' : ''}>›</button>
                <button onclick="changePage(${total})" ${currentPage === total ? 'disabled' : ''}>»</button>
            `;
            
            pagination.innerHTML = buttons;
        }

        function changePage(page) {
            currentPage = page;
            if (currentCategory) {
                fetchProductsByCategory(currentCategory, page);
            } else {
                fetchProducts(page);
            }
        }

        function redirectToProduct(productId) {
            window.location.href = `informationproduct.html?id=${productId}`;
        }

        function addToCart(event, productId, quantity) {
            event.preventDefault();
            const token = localStorage.getItem('token');
            
            if (!token) {
                Swal.fire({
                    title: 'Chưa đăng nhập!',
                    text: 'Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Đăng nhập ngay',
                    cancelButtonText: 'Để sau'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'login.html';
                    }
                });
                return;
            }

            // Hiệu ứng nút khi click
            const button = event.target;
            button.classList.add('add-to-cart-animation');
            
            // Loading state
            Swal.fire({
                title: 'Đang xử lý...',
                text: 'Vui lòng chờ trong giây lát',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('http://localhost/CuaHangDT/api/gioHang/add_to_cart.php', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: quantity
                })
            })
            .then(response => response.json())
            .then(data => {
                button.classList.remove('add-to-cart-animation');
                
                if (data.message === "Product added to cart successfully.") {
                    // Cập nht số lượng giỏ hàng
                    updateCartCount();
                    
                    // Hiệu ứng nháy đỏ
                    const cartCount = document.querySelector('.cart a');
                    cartCount.classList.add('cart-count-blink');
                    
                    setTimeout(() => {
                        cartCount.classList.remove('cart-count-blink');
                    }, 2000);

                    // Thông báo thành công
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Thêm vào giỏ hàng thành công!',
                        showConfirmButton: false,
                        timer: 1500,
                        toast: true,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Không thể thêm vào giỏ hàng',
                        text: data.message,
                        confirmButtonColor: '#d33'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                button.classList.remove('add-to-cart-animation');
                
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Có lỗi xảy ra khi thêm vào giỏ hàng',
                    confirmButtonColor: '#d33'
                });
            });
        }

        function searchProducts() {
            const searchValue = document.getElementById("search-input").value.toLowerCase();
            const products = document.querySelectorAll(".product");
            let found = false;
            
            products.forEach(product => {
                const productName = product.querySelector("h4 a").innerText.toLowerCase();
                if (productName.includes(searchValue)) {
                    product.style.display = "block";
                    found = true;
                } else {
                    product.style.display = "none";
                }
            });
            
            if (!found) {
                alert('Không tìm thấy sản phẩm phù hợp.');
            }
        }

        // Thêm hàm để lấy số lượng sản phẩm trong giỏ hng
        function updateCartCount() {
            const token = localStorage.getItem('token');
            if (!token) return;

            fetch('http://localhost/CuaHangDT/api/gioHang/read.php', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.data) {
                    // Cập nhật số lượng trong giỏ hàng
                    const cartCount = document.querySelector('.cart a');
                    const totalItems = data.data.length;
                    cartCount.innerHTML = `Giỏ hàng (${totalItems})`;
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function showSlides(containerId, index) {
            const container = document.getElementById(containerId);
            const products = container.querySelectorAll('.product');
            const totalProducts = products.length;

            // Cập nhật chỉ số nếu vượt quá số sản phẩm
            if (index >= totalProducts) {
                currentIndex = 0; // Quay lại trang đầu
            } else if (index < 0) {
                currentIndex = totalProducts - 1; // Quay lại trang cuối
            } else {
                currentIndex = index;
            }

            // Tính toán offset để lướt
            const offset = -currentIndex * (100 / itemsPerPage);
            container.style.transform = `translateX(${offset}%)`;
        }

        function nextSlide(containerId) {
            showSlides(containerId, currentIndex + 1);
        }

        function prevSlide(containerId) {
            showSlides(containerId, currentIndex - 1);
        }

        function autoSlide(containerId) {
            setInterval(() => {
                nextSlide(containerId);
            }, 2000); // Chuyển trang mỗi 2 giây
        }

        // Hàm hiển thị sản phẩm flash sale
        function displayFlashSale(products) {
            const flashSale = [...products].sort((a, b) => a.price - b.price).slice(0, 15);
            renderProducts(flashSale, 'flashsale-products');
            showSlides('flashsale-products', currentIndex); // Hiển thị trang đầu tiên
        }

        // Hàm hiển thị sản phẩm nổi bật
        function displayFeatured(products) {
            const start = (currentFeaturedPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedProducts = products.slice(start, end);
            renderProducts(paginatedProducts, 'featured-products');
            
            const totalPages = Math.ceil(products.length / itemsPerPage);
            renderPagination(totalPages);
        }

        // Hàm render sản phẩm nổi bật
        function renderFeaturedProducts(products) {
            const container = document.getElementById('featured-products');

            // Hiển thị tất cả sản phẩm nổi bật
            container.innerHTML = products.map(product => `
                <div class="product">
                    <a href="informationproduct.html?id=${product.product_id}" class="product-link">
                        <img src="${product.thumbnail_image}" alt="${product.product_name}">
                        <h4>${product.product_name}</h4>
                        <p class="product-price">Giá: ${Number(product.price).toLocaleString()} VND</p>
                    </a>
                    <button onclick="addToCart(event, ${product.product_id}, 1)">Thêm vào giỏ hàng</button>
                </div>
            `).join("");
        }

        // Hàm render phn trang
        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('pagination');
            let paginationHTML = '';

            // Nút "Quay lại"
            paginationHTML += `
                <button onclick="changeFeaturedPage(currentFeaturedPage - 1)" ${currentFeaturedPage === 1 ? 'disabled' : ''}>Quay lại</button>
            `;

            // Nút số trang
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button class="page-btn ${i === currentFeaturedPage ? 'active' : ''}"
                            onclick="changeFeaturedPage(${i})">
                        ${i}
                    </button>
                `;
            }

            // Nút "Tiếp"
            paginationHTML += `
                <button onclick="changeFeaturedPage(currentFeaturedPage + 1)" ${currentFeaturedPage === totalPages ? 'disabled' : ''}>Tiếp</button>
            `;

            paginationContainer.innerHTML = paginationHTML;
        }

        // Hàm thay đổi trang sản phẩm nổi bật
        function changeFeaturedPage(page) {
            currentFeaturedPage = page;
            displayFeatured(allProducts);
        }

        // Hàm fetch và xử lý Flash Sale riêng biệt
        function initializeFlashSale() {
            fetch('http://localhost/CuaHangDT/api/sanpham/read.php')
                .then(response => response.json())
                .then(data => {
                    const flashSaleProducts = [...data.data]
                        .sort((a, b) => a.price - b.price)
                        .slice(0, flashSaleLimit);
                    renderFlashSale(flashSaleProducts);
                    initializeFlashSaleSlider();
                })
                .catch(error => console.error('Error:', error));
        }

        // Hàm render Flash Sale
        function renderFlashSale(products) {
            const container = document.getElementById('flashsale-products');
            container.innerHTML = products.map(product => `
                <div class="product">
                    <a href="informationproduct.html?id=${product.product_id}" class="product-link">
                        <img src="${product.thumbnail_image}" alt="${product.product_name}">
                        <h4>${product.product_name}</h4>
                        <p class="product-price">Giá: ${Number(product.price).toLocaleString()} VND</p>
                    </a>
                    <button onclick="addToCart(event, ${product.product_id}, 1)">Thêm vào giỏ hàng</button>
                </div>
            `).join("");
        }

        // Các hàm điều khiển slider cho Flash Sale
        function initializeFlashSaleSlider() {
            showFlashSaleSlide(currentFlashIndex);
            setInterval(() => {
                nextFlashSaleSlide();
            }, 2000);
        }

        function showFlashSaleSlide(index) {
            const container = document.getElementById('flashsale-products');
            const products = container.querySelectorAll('.product');
            const totalProducts = products.length;

            if (index >= totalProducts) {
                currentFlashIndex = 0;
            } else if (index < 0) {
                currentFlashIndex = totalProducts - 1;
            } else {
                currentFlashIndex = index;
            }

            const offset = -currentFlashIndex * (100 / 5); // Hiển thị 5 sản phẩm một lần
            container.style.transform = `translateX(${offset}%)`;
        }

        function nextFlashSaleSlide() {
            showFlashSaleSlide(currentFlashIndex + 1);
        }

        function prevFlashSaleSlide() {
            showFlashSaleSlide(currentFlashIndex - 1);
        }

        // Hàm fetch và xử lý các sản phẩm khác
        function fetchProducts() {
            const url = `http://localhost/CuaHangDT/api/sanpham/read.php?limit=1000`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    allProducts = data.data;
                    displayFeatured(allProducts);
                })
                .catch(error => console.error('Error:', error));
        }

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            initializeFlashSale(); // Khởi tạo Flash Sale riêng
            fetchProducts(); // Fetch các sản phẩm khác
        });
        // Hàm fetch và render categories
        function fetchCategories() {
            fetch('http://localhost/CuaHangDT/api/danhMucSP/read.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Categories data:', data);
                    if (data && data.data) {
                        renderCategories(data.data);
                    } else {
                        console.error('No categories found in the response');
                    }
                })
                .catch(error => console.error('Error fetching categories:', error));
        }

        // Hàm render categories với active state
        function renderCategories(categories) {
            const categoryMenu = document.getElementById('category-menu');
            if (!categoryMenu) return;

            const categoriesHTML = `
                <li>
                    <a href="#" 
                       class="category-link ${currentCategory === 'all' ? 'active' : ''}"
                       onclick="fetchProductsByCategory('all'); return false;">
                        Tất cả sản phẩm
                    </a>
                </li>
                ${categories.map(category => `
                    <li>
                        <a href="#" 
                           class="category-link ${currentCategory === category.category_id ? 'active' : ''}"
                           onclick="fetchProductsByCategory('${category.category_id}'); return false;">
                            ${category.category_name}
                        </a>
                    </li>
                `).join('')}`;
            
            categoryMenu.innerHTML = categoriesHTML;
        }

        // Hàm fetch products theo category
        function fetchProductsByCategory(categoryId) {
            currentCategory = categoryId;
            currentPage = 1;
            
            const limit = document.getElementById('items-per-page').value;
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value;

            // Cập nht active state cho categories
            updateCategoryActiveState(categoryId);

            // Hiển thị loading
            const productList = document.getElementById('featured-products');
            productList.innerHTML = '<div class="loading">Đang tải sản phẩm...</div>';

            // Luôn sử dụng API read.php của sản phẩm
            let url = `http://localhost/CuaHangDT/api/sanpham/read.php`;
            
            // Thêm các tham số query
            const params = new URLSearchParams({
                page: currentPage,
                limit: limit,
                sort_by: sortBy,
                sort_order: sortOrder
            });

            // Thêm category_id nếu không phải "Tất cả"
            if (categoryId !== 'all') {
                params.append('category_id', categoryId);
            }

            url += '?' + params.toString();
            console.log('Fetching URL:', url); // Debug log

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data); // Debug log
                    
                    if (!data.data || data.data.length === 0) {
                        productList.innerHTML = '<div class="no-products">Không có sản phẩm trong danh mục này</div>';
                        return;
                    }

                    renderProducts(data.data);
                    if (data.total_pages) {
                        renderPagination(data.total_pages);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    productList.innerHTML = '<div class="error">Có lỗi xảy ra khi tải sản phẩm</div>';
                });
        }

        // Hàm cập nhật active state cho categories
        function updateCategoryActiveState(categoryId) {
            const links = document.querySelectorAll('.category-link');
            links.forEach(link => {
                link.classList.remove('active');
                if ((categoryId === 'all' && link.textContent.trim() === 'Tất cả sản phẩm') ||
                    link.getAttribute('onclick').includes(categoryId)) {
                    link.classList.add('active');
                }
            });
        }

        // Thêm CSS cho styling
        const styles = `
        <style>
            .category-link {
                display: inline-block;
                padding: 8px 15px;
                margin: 5px;
                background-color: #f0f0f0;
                border-radius: 5px;
                text-decoration: none;
                color: #333;
                transition: all 0.3s ease;
            }

            .category-link:hover {
                background-color: #e0e0e0;
            }

            .category-link.active {
                background-color: #4CAF50;
                color: white;
            }

            .loading {
                text-align: center;
                padding: 20px;
                color: #666;
            }

            .error {
                text-align: center;
                padding: 20px;
                color: #dc3545;
                background-color: #f8d7da;
                border-radius: 4px;
            }

            .no-products {
                text-align: center;
                padding: 20px;
                color: #856404;
                background-color: #fff3cd;
                border-radius: 4px;
            }
        </style>
        `;

        // Th��m styles vào head
        document.head.insertAdjacentHTML('beforeend', styles);

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            fetchCategories();
            fetchProductsByCategory('all'); // Load tt cả sản phẩm ban đầu
            
            // Thêm event listener cho các controls
            document.getElementById('items-per-page').addEventListener('change', () => {
                fetchProductsByCategory(currentCategory);
            });
            
            document.getElementById('sort-by').addEventListener('change', () => {
                fetchProductsByCategory(currentCategory);
            });
            
            document.getElementById('sort-order').addEventListener('change', () => {
                fetchProductsByCategory(currentCategory);
            });
        });

        // Hàm lọc sản phẩm theo category
        function filterProducts(categoryId) {
            console.log('Filtering products for category:', categoryId);
            currentCategory = categoryId;

            // Hiển thị loading
            const productList = document.getElementById('featured-products');
            productList.innerHTML = 'Đang tải sản phẩm...';

            // Fetch tất cả sản phẩm
            fetch('http://localhost/CuaHangDT/api/sanpham/read.php')
                .then(response => response.json())
                .then(data => {
                    console.log('Products data:', data);
                    if (data.data) {
                        let filteredProducts;
                        
                        if (categoryId === 'all') {
                            // Hiển thị tất cả sản phẩm
                            filteredProducts = data.data;
                        } else {
                            // Lọc sản phẩm theo category_id
                            filteredProducts = data.data.filter(product => 
                                product.category_id === categoryId
                            );
                        }

                        if (filteredProducts.length > 0) {
                            renderProducts(filteredProducts);
                        } else {
                            productList.innerHTML = 'Không có sản phẩm trong danh mục này.';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    productList.innerHTML = 'Có lỗi xảy ra khi tải sản phẩm.';
                });

            // Cập nhật active state cho categories
            updateActiveCategoryLink(categoryId);
        }

        // Hàm render products
        function renderProducts(products) {
            const productList = document.getElementById('featured-products');
            
            if (!products || products.length === 0) {
                productList.innerHTML = 'Không có sản phẩm nào.';
                return;
            }

            console.log('Rendering products:', products); // Debug log

            const productsHTML = products.map(product => `
                <div class="product">
                    <a href="informationproduct.html?id=${product.product_id}">
                        <img src="${product.thumbnail_image}" alt="${product.product_name}">
                        <h4>${product.product_name}</h4>
                        <p>Giá: ${Number(product.price).toLocaleString()} VND</p>
                    </a>
                    <button onclick="addToCart(event, ${product.product_id}, 1)">Thêm vào giỏ hàng</button>
                </div>
            `).join('');

            productList.innerHTML = productsHTML;
        }

        // Hàm render categories
        function renderCategories(categories) {
            const categoryMenu = document.getElementById('category-menu');
            if (!categoryMenu) return;

            // Thêm "Tất cả sản phẩm" và các categories khác
            categoryMenu.innerHTML = `
                <li>
                    <a href="#" onclick="filterProducts('all'); return false;">
                        Tất cả sản phẩm
                    </a>
                </li>
                ${categories.map(category => `
                    <li>
                        <a href="#" onclick="filterProducts('${category.category_id}'); return false;">
                            ${category.category_name}
                        </a>
                    </li>
                `).join('')}`;
        }

        // Thêm vào phần đầu của file, sau khi trang đã load
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy token từ localStorage
            const token = localStorage.getItem('token');
            // Lấy trạng thái đã xem welcome của phiên đăng nhập hiện tại
            const hasSeenWelcome = sessionStorage.getItem('hasSeenWelcome');
            
            // Chỉ hiện thông báo nếu đang đăng nhập và chưa xem welcome trong phiên này
            if (token && !hasSeenWelcome) {
                Swal.fire({
                    title: 'Chào mừng đến với Điện máy Xa Lánh!',
                    text: 'Nơi mua sắm điện thoại uy tín và chất lượng',
                    imageUrl: 'img/logo.png',
                    imageWidth: 200,
                    imageHeight: 200,
                    imageAlt: 'Logo Điện máy Xa Lánh',
                    showConfirmButton: true,
                    confirmButtonText: 'Bắt đầu mua sắm',
                    confirmButtonColor: '#4a3d93',
                    showDenyButton: true,
                    denyButtonText: 'Không hiện lại trong phiên này',
                    timer: 3000,
                    timerProgressBar: true,
                    backdrop: `
                        rgba(0,0,123,0.4)
                        url("path/to/your/background.gif")
                        left top
                        no-repeat
                    `,
                    customClass: {
                        popup: 'welcome-popup'
                    }
                }).then((result) => {
                    if (result.isDenied) {
                        // Lưu trạng thái đã xem vào sessionStorage thay vì localStorage
                        sessionStorage.setItem('hasSeenWelcome', 'true');
                    }
                });
            }

            // Các code khởi tạo khác của bạn
            initializeFlashSale();
            fetchProducts();
        });

        // Sửa lại hàm reset để test
        function resetWelcomeMessage() {
            sessionStorage.removeItem('hasSeenWelcome');
            location.reload();
        }

        // Style cho popup
        const style = document.createElement('style');
        style.textContent = `
            .welcome-popup {
                border-radius: 15px;
                background: linear-gradient(145deg, #ffffff, #f0f0f0);
                box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>